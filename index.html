<!DOCTYPE html>
<html>
<head>
<meta charset="utf-8">
<title>Mapa</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">

<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css">
<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

<style>
html, body, #map {
  height: 100%;
  margin: 0;
}
</style>
</head>

<body>
<div id="map"></div>

<script>
const API_KEY = "eyJvcmciOiI1YjNjZTM1OTc4NTExMTAwMDFjZjYyNDgiLCJpZCI6IjZhMTUxMmFkOTcxNjQzYTFhYzg1NDkwODBjYTk5ZmZiIiwiaCI6Im11cm11cjY0In0=";

let map = L.map('map').setView([-18.4783, -70.3126], 14);
L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png').addTo(map);

let puntos = [];
let marcadores = [];
let linea = null;

/* ðŸ“ UbicaciÃ³n actual */
navigator.geolocation.getCurrentPosition(pos => {
  let lat = pos.coords.latitude;
  let lng = pos.coords.longitude;
  L.circleMarker([lat, lng], { radius: 6, color: 'blue' }).addTo(map);
  map.setView([lat, lng], 15);
});

/* ðŸ‘‰ Agregar puntos */
map.on('click', e => {
  marcadores.push(L.marker(e.latlng).addTo(map));
  puntos.push([e.latlng.lng, e.latlng.lat]);
});

/* ðŸ”™ Deshacer Ãºltimo punto */
function undoLastPoint() {
  if (marcadores.length > 0) {
    map.removeLayer(marcadores.pop());
    puntos.pop();
  }
}

/* ðŸ§¹ Limpiar todo */
function clearAll() {
  marcadores.forEach(m => map.removeLayer(m));
  marcadores = [];
  puntos = [];
  if (linea) map.removeLayer(linea);
  linea = null;
}

/* ðŸš¶ Calcular ruta */
async function calculateRoute() {
  if (puntos.length < 2) {
    alert("Agrega al menos 2 puntos");
    return;
  }

  const res = await fetch(
    "https://api.openrouteservice.org/v2/directions/foot-walking/geojson",
    {
      method: "POST",
      headers: {
        "Authorization": API_KEY,
        "Content-Type": "application/json"
      },
      body: JSON.stringify({ coordinates: puntos })
    }
  );

  const data = await res.json();

  if (linea) map.removeLayer(linea);

  linea = L.geoJSON(data, {
    style: { color: "red", weight: 5 }
  }).addTo(map);

  /* ðŸ“¤ Enviar a App Inventor (lat,lng|lat,lng) */
  let texto = "";
  data.features[0].geometry.coordinates.forEach(p => {
    texto += p[1] + "," + p[0] + "|";
  });
  texto = texto.slice(0, -1);

  if (window.AppInventor) {
    window.AppInventor.setWebViewString(texto);
  }
}

/* ================================================= */
/* âœ… DIBUJAR RUTA GUARDADA DESDE APP INVENTOR        */
/* ================================================= */

function dibujarRuta(textoRuta) {

  if (!textoRuta || textoRuta.length === 0) return;

  // borrar ruta anterior
  if (linea) {
    map.removeLayer(linea);
  }

  // convertir "lat,lng|lat,lng" â†’ [[lat,lng],[lat,lng]]
  let coords = textoRuta.split("|").map(p => {
    let partes = p.split(",");
    return [parseFloat(partes[0]), parseFloat(partes[1])];
  });

  linea = L.polyline(coords, {
    color: "blue",
    weight: 5
  }).addTo(map);

  map.fitBounds(linea.getBounds());
}

/* ðŸŽ¯ Exponer funciones a App Inventor */
window.calculateRoute = calculateRoute;
window.undoLastPoint = undoLastPoint;
window.clearAll = clearAll;
window.dibujarRuta = dibujarRuta;

</script>
</body>
</html>
